# Pipeline multietapa reutilizable.
# Permite elegir tipo de build, flujos (stages) y tareas dentro de cada job.
# Llamado desde ci.yml y cd.yml (y opcionalmente manual con workflow_dispatch).

name: Pipeline (reusable)

on:
  workflow_call:
    inputs:
      # Tipo de build: full | frontend | backend | storybook | lint-only | test-only
      build_type:
        required: false
        default: 'full'
        type: string
      # Stages (comma-separated): lint, test-unit, test-e2e, security, build
      stages:
        required: false
        default: 'lint,test-unit,test-e2e,security,build'
        type: string
      # Tareas dentro de lint: lint, typecheck, format (comma-separated, o 'all')
      tasks_lint:
        required: false
        default: 'all'
        type: string
      # Tareas dentro de test: unit, e2e (comma-separated, o 'all')
      tasks_test:
        required: false
        default: 'all'
        type: string
      # Tareas de security: snyk, sonar (comma-separated, o 'all')
      tasks_security:
        required: false
        default: 'all'
        type: string
      # NODE_VERSION / PNPM_VERSION
      node_version:
        required: false
        default: '20'
        type: string
      pnpm_version:
        required: false
        default: '10'
        type: string
    secrets:
      SNYK_TOKEN:
        required: false
      SONAR_TOKEN:
        required: false

jobs:
  # ========================================
  # PARAMS: deriva flags desde inputs (build_type, stages, tasks)
  # ========================================
  params:
    name: ðŸ“‹ Params
    runs-on: ubuntu-latest
    outputs:
      run_lint: ${{ steps.out.outputs.run_lint }}
      run_typecheck: ${{ steps.out.outputs.run_typecheck }}
      run_format: ${{ steps.out.outputs.run_format }}
      run_tests: ${{ steps.out.outputs.run_tests }}
      run_e2e: ${{ steps.out.outputs.run_e2e }}
      run_snyk: ${{ steps.out.outputs.run_snyk }}
      run_sonar: ${{ steps.out.outputs.run_sonar }}
      run_build_frontend: ${{ steps.out.outputs.run_build_frontend }}
      run_build_backend: ${{ steps.out.outputs.run_build_backend }}
      run_build_storybook: ${{ steps.out.outputs.run_build_storybook }}
    steps:
      - name: Set params
        id: out
        run: |
          BUILD_TYPE="${{ inputs.build_type }}"
          STAGES="${{ inputs.stages }}"
          TASKS_LINT="${{ inputs.tasks_lint }}"
          TASKS_TEST="${{ inputs.tasks_test }}"
          TASKS_SECURITY="${{ inputs.tasks_security }}"

          stage_has() { echo "$STAGES" | tr ',' '\n' | grep -qx "$1"; }
          task_lint_has() { [ "$TASKS_LINT" = "all" ] || echo "$TASKS_LINT" | tr ',' '\n' | grep -qx "$1"; }
          task_test_has() { [ "$TASKS_TEST" = "all" ] || echo "$TASKS_TEST" | tr ',' '\n' | grep -qx "$1"; }
          task_sec_has() { [ "$TASKS_SECURITY" = "all" ] || echo "$TASKS_SECURITY" | tr ',' '\n' | grep -qx "$1"; }

          RUN_LINT="false"; (stage_has "lint" && (task_lint_has "lint" || [ "$TASKS_LINT" = "all" ])) && RUN_LINT="true"
          RUN_TYPECHECK="false"; (stage_has "lint" && (task_lint_has "typecheck" || [ "$TASKS_LINT" = "all" ])) && RUN_TYPECHECK="true"
          RUN_FORMAT="false"; (stage_has "lint" && (task_lint_has "format" || [ "$TASKS_LINT" = "all" ])) && RUN_FORMAT="true"
          RUN_TESTS="false"; (stage_has "test-unit" && (task_test_has "unit" || [ "$TASKS_TEST" = "all" ])) && RUN_TESTS="true"
          RUN_E2E="false"; (stage_has "test-e2e" && (task_test_has "e2e" || [ "$TASKS_TEST" = "all" ])) && RUN_E2E="true"
          RUN_SNYK="false"; (stage_has "security" && (task_sec_has "snyk" || [ "$TASKS_SECURITY" = "all" ])) && RUN_SNYK="true"
          RUN_SONAR="false"; (stage_has "security" && (task_sec_has "sonar" || [ "$TASKS_SECURITY" = "all" ])) && RUN_SONAR="true"

          case "$BUILD_TYPE" in
            full) RUN_FRONT="true"; RUN_BACK="true"; RUN_STORY="true" ;;
            frontend) RUN_FRONT="true"; RUN_BACK="false"; RUN_STORY="false" ;;
            backend) RUN_FRONT="false"; RUN_BACK="true"; RUN_STORY="false" ;;
            storybook) RUN_FRONT="false"; RUN_BACK="false"; RUN_STORY="true" ;;
            *) RUN_FRONT="false"; RUN_BACK="false"; RUN_STORY="false" ;;
          esac
          [ "$RUN_FRONT" != "true" ] && RUN_FRONT="false"
          [ "$RUN_BACK" != "true" ] && RUN_BACK="false"
          [ "$RUN_STORY" != "true" ] && RUN_STORY="false"
          stage_has "build" || { RUN_FRONT="false"; RUN_BACK="false"; RUN_STORY="false"; }

          echo "run_lint=$RUN_LINT" >> $GITHUB_OUTPUT
          echo "run_typecheck=$RUN_TYPECHECK" >> $GITHUB_OUTPUT
          echo "run_format=$RUN_FORMAT" >> $GITHUB_OUTPUT
          echo "run_tests=$RUN_TESTS" >> $GITHUB_OUTPUT
          echo "run_e2e=$RUN_E2E" >> $GITHUB_OUTPUT
          echo "run_snyk=$RUN_SNYK" >> $GITHUB_OUTPUT
          echo "run_sonar=$RUN_SONAR" >> $GITHUB_OUTPUT
          echo "run_build_frontend=$RUN_FRONT" >> $GITHUB_OUTPUT
          echo "run_build_backend=$RUN_BACK" >> $GITHUB_OUTPUT
          echo "run_build_storybook=$RUN_STORY" >> $GITHUB_OUTPUT

  # ========================================
  # STAGE: LINT
  # ========================================
  lint:
    name: ðŸ” Lint
    runs-on: ubuntu-latest
    needs: [params]
    if: needs.params.outputs.run_lint == 'true'
    timeout-minutes: 10
    env:
      NODE_VERSION: ${{ inputs.node_version }}
      PNPM_VERSION: ${{ inputs.pnpm_version }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - name: ESLint
        run: pnpm nx run-many -t lint --projects=front-biosstel,api-biosstel --skip-nx-cache

  format-check:
    name: ðŸ“ Format (Prettier)
    runs-on: ubuntu-latest
    needs: [params]
    if: needs.params.outputs.run_format == 'true'
    timeout-minutes: 5
    env:
      NODE_VERSION: ${{ inputs.node_version }}
      PNPM_VERSION: ${{ inputs.pnpm_version }}

    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm run format:check

  typecheck:
    name: ðŸ” TypeCheck
    runs-on: ubuntu-latest
    needs: [params]
    if: needs.params.outputs.run_typecheck == 'true'
    timeout-minutes: 10
    env:
      NODE_VERSION: ${{ inputs.node_version }}
      PNPM_VERSION: ${{ inputs.pnpm_version }}

    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm run typecheck:front
      - run: pnpm run typecheck:api

  # ========================================
  # STAGE: TEST
  # ========================================
  test-unit:
    name: ðŸ§ª Unit Tests & Coverage
    runs-on: ubuntu-latest
    needs: [params]
    if: needs.params.outputs.run_tests == 'true'
    timeout-minutes: 15
    env:
      NODE_VERSION: ${{ inputs.node_version }}
      PNPM_VERSION: ${{ inputs.pnpm_version }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm run test:coverage
        env:
          CI: true
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 14
      - name: Coverage summary
        if: always()
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            echo "## ðŸ“Š Coverage Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            node -e "
              const r = require('./coverage/coverage-summary.json').total;
              const fmt = (v) => v.pct + '%';
              console.log('| Metric | Coverage |');
              console.log('|--------|----------|');
              console.log('| Statements | ' + fmt(r.statements) + ' |');
              console.log('| Branches | ' + fmt(r.branches) + ' |');
              console.log('| Functions | ' + fmt(r.functions) + ' |');
              console.log('| Lines | ' + fmt(r.lines) + ' |');
            " >> $GITHUB_STEP_SUMMARY
          fi

  test-e2e:
    name: ðŸ§ª E2E Tests
    runs-on: ubuntu-latest
    needs: [params]
    if: needs.params.outputs.run_e2e == 'true'
    timeout-minutes: 20
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: biosstel
          POSTGRES_PASSWORD: biosstel123
          POSTGRES_DB: biosstel_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5433:5432
    env:
      NODE_VERSION: ${{ inputs.node_version }}
      PNPM_VERSION: ${{ inputs.pnpm_version }}

    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm run playwright:install
      - run: pnpm run db:seed
        env:
          DB_HOST: localhost
          DB_PORT: 5433
          DB_USER: biosstel
          DB_PASSWORD: biosstel123
          DB_NAME: biosstel_test
      - run: pnpm run test:e2e
        env:
          CI: true
          DB_HOST: localhost
          DB_PORT: 5433
          DB_USER: biosstel
          DB_PASSWORD: biosstel123
          DB_NAME: biosstel_test
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  # ========================================
  # STAGE: SECURITY
  # ========================================
  snyk:
    name: ðŸ›¡ï¸ Snyk
    runs-on: ubuntu-latest
    needs: [params]
    if: needs.params.outputs.run_snyk == 'true'
    timeout-minutes: 10
    env:
      NODE_VERSION: ${{ inputs.node_version }}
      PNPM_VERSION: ${{ inputs.pnpm_version }}

    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --all-projects
          command: test
      - uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
          command: code test

  sonar:
    name: ðŸ“¡ SonarCloud
    runs-on: ubuntu-latest
    needs: [params, test-unit]
    if: needs.params.outputs.run_sonar == 'true' && needs.test-unit.result == 'success'
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/download-artifact@v4
        with:
          name: coverage-report
          path: coverage/
      - uses: SonarSource/sonarqube-scan-action@v5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
      - uses: SonarSource/sonarqube-quality-gate-action@v1
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # ========================================
  # STAGE: BUILD (jobs separados por tipo)
  # ========================================
  build-frontend:
    name: ðŸ—ï¸ Build Frontend
    runs-on: ubuntu-latest
    needs: [params, lint, typecheck, format-check, test-unit]
    if: |
      always() &&
      needs.params.outputs.run_build_frontend == 'true' &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped') &&
      (needs.test-unit.result == 'success' || needs.test-unit.result == 'skipped')
    timeout-minutes: 15
    env:
      NODE_VERSION: ${{ inputs.node_version }}
      PNPM_VERSION: ${{ inputs.pnpm_version }}

    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm run build:front
        env:
          NODE_ENV: production
      - uses: actions/upload-artifact@v4
        with:
          name: build-frontend
          path: apps/front-biosstel/.next
          retention-days: 7

  build-backend:
    name: ðŸ—ï¸ Build Backend
    runs-on: ubuntu-latest
    needs: [params, lint, typecheck, format-check, test-unit]
    if: |
      always() &&
      needs.params.outputs.run_build_backend == 'true' &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped') &&
      (needs.test-unit.result == 'success' || needs.test-unit.result == 'skipped')
    timeout-minutes: 15
    env:
      NODE_VERSION: ${{ inputs.node_version }}
      PNPM_VERSION: ${{ inputs.pnpm_version }}

    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm run build:api
        env:
          NODE_ENV: production
      - uses: actions/upload-artifact@v4
        with:
          name: build-backend
          path: apps/api-biosstel/dist
          retention-days: 7

  build-storybook:
    name: ðŸ—ï¸ Build Storybook
    runs-on: ubuntu-latest
    needs: [params, lint, typecheck, format-check, test-unit]
    if: |
      always() &&
      needs.params.outputs.run_build_storybook == 'true' &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped') &&
      (needs.test-unit.result == 'success' || needs.test-unit.result == 'skipped')
    timeout-minutes: 15
    env:
      NODE_VERSION: ${{ inputs.node_version }}
      PNPM_VERSION: ${{ inputs.pnpm_version }}

    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm exec nx run front-biosstel:build-storybook
      - uses: actions/upload-artifact@v4
        with:
          name: build-storybook
          path: storybook-static
          retention-days: 7

  # ========================================
  # SUCCESS GATE
  # ========================================
  ci-success:
    name: âœ… Pipeline Success
    runs-on: ubuntu-latest
    needs: [params, lint, typecheck, format-check, test-unit, test-e2e, snyk, sonar, build-frontend, build-backend, build-storybook]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## ðŸ Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TypeCheck | ${{ needs.typecheck.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Format | ${{ needs.format-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.test-unit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.test-e2e.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Snyk | ${{ needs.snyk.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Sonar | ${{ needs.sonar.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Frontend | ${{ needs.build-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Backend | ${{ needs.build-backend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Storybook | ${{ needs.build-storybook.result }} |" >> $GITHUB_STEP_SUMMARY
          FAIL=0
          [ "${{ needs.lint.result }}" != "success" ] && [ "${{ needs.lint.result }}" != "skipped" ] && FAIL=1
          [ "${{ needs.test-unit.result }}" != "success" ] && [ "${{ needs.test-unit.result }}" != "skipped" ] && FAIL=1
          if [ "${{ needs.params.outputs.run_e2e }}" = "true" ]; then
            [ "${{ needs.test-e2e.result }}" != "success" ] && FAIL=1
          fi
          if [ "${{ needs.params.outputs.run_build_frontend }}" = "true" ]; then
            [ "${{ needs.build-frontend.result }}" != "success" ] && FAIL=1
          fi
          if [ "${{ needs.params.outputs.run_build_backend }}" = "true" ]; then
            [ "${{ needs.build-backend.result }}" != "success" ] && FAIL=1
          fi
          if [ "${{ needs.params.outputs.run_build_storybook }}" = "true" ]; then
            [ "${{ needs.build-storybook.result }}" != "success" ] && FAIL=1
          fi
          [ $FAIL -eq 1 ] && exit 1
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Pipeline passed**" >> $GITHUB_STEP_SUMMARY
