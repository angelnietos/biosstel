name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8'

jobs:
  # ========================================
  # ðŸ“‹ PR INFO
  # ========================================
  pr-info:
    name: ðŸ“‹ PR Information
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“‹ PR Details
        run: |
          echo "### ðŸ“‹ Pull Request Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Title:** ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Author:** @${{ github.event.pull_request.user.login }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Base:** \`${{ github.event.pull_request.base.ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Head:** \`${{ github.event.pull_request.head.ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commits:** ${{ github.event.pull_request.commits }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Changed files:** ${{ github.event.pull_request.changed_files }}" >> $GITHUB_STEP_SUMMARY

  # ========================================
  # ðŸ” CHANGED FILES
  # ========================================
  detect-changes:
    name: ðŸ” Detect Changes
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}
      libs: ${{ steps.filter.outputs.libs }}
      ci: ${{ steps.filter.outputs.ci }}
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ” Detect changed files
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            frontend:
              - 'apps/front-biosstel/**'
              - 'libs/frontend/**'
            backend:
              - 'apps/api-biosstel/**'
              - 'libs/backend/**'
            libs:
              - 'libs/**'
            ci:
              - '.github/workflows/**'

  # ========================================
  # ðŸ” CONDITIONAL LINT
  # ========================================
  lint-frontend:
    name: ðŸ” Lint Frontend
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.frontend == 'true'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      
      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: ðŸ” Lint
        run: pnpm run lint:front

  lint-backend:
    name: ðŸ” Lint Backend
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.backend == 'true'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      
      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: ðŸ” Lint
        run: pnpm run lint:api

  # ========================================
  # ðŸ“Š SIZE CHECK
  # ========================================
  bundle-size:
    name: ðŸ“Š Bundle Size Check
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.frontend == 'true'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      
      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: ðŸ—ï¸ Build frontend
        run: pnpm run build:front
        env:
          NODE_ENV: production
      
      - name: ðŸ“Š Analyze bundle
        run: |
          echo "### ðŸ“Š Bundle Size" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          du -sh apps/front-biosstel/.next >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # ========================================
  # âœ… PR STATUS
  # ========================================
  pr-status:
    name: âœ… PR Status
    runs-on: ubuntu-latest
    needs: [pr-info, detect-changes]
    if: always()
    
    steps:
      - name: ðŸ“Š Summary
        run: |
          echo "### âœ… PR Status Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend changed: ${{ needs.detect-changes.outputs.frontend }}" >> $GITHUB_STEP_SUMMARY
          echo "- Backend changed: ${{ needs.detect-changes.outputs.backend }}" >> $GITHUB_STEP_SUMMARY
          echo "- Libraries changed: ${{ needs.detect-changes.outputs.libs }}" >> $GITHUB_STEP_SUMMARY
          echo "- CI changed: ${{ needs.detect-changes.outputs.ci }}" >> $GITHUB_STEP_SUMMARY
